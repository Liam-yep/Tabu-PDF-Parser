# מסמך חפיפה - פירוק נסח טאבו (PDF) ל-Monday

## סקירה כללית
פרויקט זה הוא אינטגרציה ב-Node.js עבור Monday.com. המטרה העיקרית שלו היא לפרק קבצי **PDF (נסחי טאבו)** שמצורפים לפריטים ב-Monday וליצור באופן אוטומטי ישויות מקושרות בלוחות Monday אחרים: **תתי-חלקות (Subunits)** ו-**בעלים (Owners)**.

המערכת תומכה במספר "חשבונות" (Accounts) שונים (כגון Katagroup, Gabay Group, Reuven Ayz), כאשר לכל חשבון מוגדרים הלוחות והעמודות הרלוונטיים לו.

## מבנה המערכת והלוחות
עבור כל פרויקט/חשבון, המערכת מצפה לשלושה לוחות מרכזיים:
1.  **לוח יחידות/חלקות (Units Board)**: הלוח הראשי שבו הטריגר מתבצע.
2.  **לוח תתי-חלקות (Subunits Board)**: הלוח אליו יועלו התתי-החלקות.
3.  **לוח בעלים (Owners Board)**: הלוח אליו יועלו הבעלים של כל דירה.

## איך זה עובד
### טריגר
התהליך מתחיל כאשר משתמש מפעיל פעולה בלוח (שינוי סטטוס) אשר שולחת בקשה לנתיב `/monday/sendPdf` (דרך הקונטרולר).

### תהליך (High Level)
1.  **קבלת הבקשה**: השרת מקבל את ה-`itemId`, `userId` ו-`accountId`.
2.  **הורדת הקובץ**: המערכת מאתרת את קובץ ה-PDF בעמודת הקבצים ומורידה אותו.
3.  **עיבוד וניתוח (Parsing)**: הקובץ עובר ל-`pdf_parser.js` לפונקציה processPdfFile שעושה את כל הניתוח של ה-PDF מחלץ ממנו את:
   *   מספר גוש וחלקה.
   *   שטח הרכוש המשותף.
   *   רשימת תתי-חלקות (דירות) עם נתונים כמו שטח, קומה, הצמדות (חניה, גג, מחסן).
   *   רשימת בעלים לכל תת-חלקה (כולל ת"ז, חלק בנכס, סוג בעלות).
החילוץ מתבצע לפי תבניות קבועות לדוגמה ידוע שאיפה שיש את המילה "בעלויות" אחרי זה יהיה את הבעלים במקומות קבועים על המסך ככה שבדקתי מה בדיוק המיקום של כל דבר לדוגמה המיקום של תז זה בשורה שאחרי במיקום בין [167, 244]. את הבדיקה ביצעתי בעזרת:
`import { getDocument } from "pdfjs-dist/legacy/build/pdf.mjs";`
ובמידה ויש בקשות חדשות לחילוץ אני בעזרת זה בודק מה המיקום של מה שרוצים לחלץ על המסך.
 
4.  **סנכרון ל-Monday**:
   *   **עדכון החלקה**: עדכון השם ועמודות הגוש, חלקה ושטח משותף בלוח הראשי באייטם שממנו זה הגיע.
   *   **סנכרון תתי-חלקות**: יצירה/עדכון/מחיקה של שורות בלוח "תתי-חלקות" וקישורן לחלקה הראשית.
   *   **סנכרון בעלים**: יצירה/עדכון/מחיקה של שורות בלוח "בעלים" וקישורן לתת-החלקה הרלוונטית.
5.  **טיפול בשגיאות**: במידה ויש שגיאות (קובץ לא תקין, כישלון ביצירת פריט), המערכת מעדכנת עמודת "שגיאות טכניות" בלוח הראשי ושולחת נוטיפיקציה למשתמש.

## זרימת הלוגיקה המרכזית ושכבות הקוד
הלוגיקה מחולקת למספר קבצים מרכזיים בתיקיית `src`:

### 1. `controllers/monday-controller.js`
המנצח על התזמורת. הפונקציה `sendPdf`:
*   מורידה את הקובץ.
*   קוראת ל-`processPdfFile` לפירוק המידע.
*   קוראת ל-`change_units_columns` לעדכון הלוח הראשי.
*   קוראת ל-`syncSubunits` ול-`syncOwners` להעלאת הנתונים.
*   מטפלת בלוגיקה של מחיקת קובץ זמני ודיווח שגיאות (`send_technical_notes`).

### 2. `services/pdf_parser.js`
המוח מאחורי פירוק ה-PDF.
*   משתמש ב-`pdfjs-dist` כדי לקרוא את הטקסט מהקובץ.
*   `cleanLinesFromHeaderBlock`: מנקה את ההדרים ומחלץ גוש/חלקה.
*   `splitIntoSubUnits`: מזהה התחלה של כל תת-חלקה (לפי טקסט "תת חלקה X").
*   `extractSubunitData`: שולף שטח, קומה, הצמדות (גג/חניה ע"י זיהוי מילות מפתח וחיבור שטחים), משכנתאות.
*   `extractOwners` / `extractLeases`: מפרסר את טבלאות הבעלויות והחכירות, מזהה שמות, ת"ז וחלק בנכס, ומנקה נתונים (כמו הסרת סוגריים מהשמות).

### 3. `services/monday-upload-subunits.js`
אחראי על העלאת תתי-חלקות.
*   מבצע התאמה בין הנתונים שחולצו לעמודות ב-Monday (לפי המיפוי בקונפיגורציה).
*   מחשב אחוזים משותפים (`parsePercentage`).
*   יוצר או מעדכן פריטים ב-Monday (כולל Retries במקרה של כישלון רשת).

### 4. `services/monday-upload-owners.js`
אחראי על העלאת בעלים.
*   דומה ללוגיקה של תתי-החלקות, אך מקשר כל בעל לתת-החלקה המתאימה לו.
*   מטפל בפרטי בעלות, סוג זיהוי, ות"ז.

### 5. `services/monday-service.js`
שירות כללי לעבודה מול ה-API של Monday. כולל פונקציות עזר כמו:
*   `getFileInfo`: קבלת לינק להורדה.
*   `send_technical_notes`: כתיבת לוג שגיאות לעמודה ייעודית בלוח.
*   `get_existing_subunits` / `get_existing_owners`: בדיקה מה כבר קיים בלוח כדי למנוע כפילויות (אם כי הלוגיקה העיקרית היא יצירה/עדכון).

## קונפיגורציה (`src/helpers/config/account-config.js`)
הלב של ההגדרות. לכל `accountId` (מזהה חשבון במאנדיי) מוגדר אובייקט המכיל:
*   **units**: הגדרות לוח החלקות (ID של הלוח, עמודות מקור, עמודות שגיאה).
*   **subunits**: הגדרות לוח תתי-החלקות (ID של הלוח, מיפוי עמודות כמו "שטח במר" -> `numeric_mks1ka3t`).
*   **owners**: הגדרות לוח הבעלים.

**דוגמה למבנה קונפיגורציה:**
```javascript
"27435948": { // Account ID
   account_name: "Katagroup",
   subunits: {
       boardId: 1923677090,
       columnMap: {
           "שטח במר": "numeric_mks1ka3t",
            // ... עוד מיפויים
       }
   },
   // ... הגדרות units ו-owners
}
```

## הערות ובעיות נפוצות
1.  **איכות קבצי ה-PDF**: הקוד מותאם לקבצי טאבו דיגיטליים טקסטואליים. סריקות (תמונות בתוך PDF) לא יעבדו טוב או לא יעבדו בכלל.
2.  **שינוי מבנה נסח**: אם רשות המקרקעין תשנה את פורמט הנסח באופן קיצוני, יהיה צורך להתאים את ה-Regex ב-`pdf_parser.js`.
3.  **מגבלות API**: הקוד מבצע קריאות `mutation` ביחידות (ולא ב-batch גדול מאוד) כדי להימנע מ-Complexity Budget, ויש למנגנון Retries (עד 3 ניסיונות) לכל פריט.
4.  **זיהוי שדות**: המערכת מסתמכת על מיקומים (קואורדינטות X) ומילות מפתח ("הערות", "משכנתאות") בתוך ה-PDF. שינוי במיקומים אלו בנסח עשוי לגרום לפספוס נתונים.

## אותנטיקציה
הקוד עובד עם OAuth2 וברגע שמורידים את האפליקציה לחשבון אז עוברים תהליך OAuth שיוצר טוקן ואז הקוד משתמש בטוקן הזה.

התהליך OAuth נשלח לראוט '/auth' וה redirect זה '/auth/callback'. זה הקובץ auth.js.
והטוקן נשמר ב SecureStorage של מאנדיי.
כל המשתנים שאנחנו שולפים בתהליך הזה אפשר להגיע אליהם בקישור הזה https://katagroup-unit.monday.com/apps/manage/10458486/app_versions/11831366/sections/monday_code_general
